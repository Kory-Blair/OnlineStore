@model OnlineStore.Models.Purchase
@{
    ViewBag.Title = "Index";
}

<h2>Shopping Cart</h2>
@using (Html.BeginForm())
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Item</th>
                <th>Frequency</th>
                <th>Price</th>
                <th>Item Total</th>
            </tr>
        </thead>
        <tbody>
            
            @if (Model.Service != null)
            {
            <tr>
                <td>
                    @Model.Service.Name
                    @Html.HiddenFor(m => m.Service.Name)
                </td>
                <td>
                    @Html.DropDownList("Recurrence", Model.Service.ServiceRecurrences.Select(x => new SelectListItem { Text = x.Recurrence.Name, Value = x.RecurrenceID.ToString() }))
                    @Html.HiddenFor(m => m.Recurrence.Id)
                </td>
                <td>
                    <span class="basePrice">@((Model.Price ?? 0).ToString("C"))</span>
                    @Html.HiddenFor(m => m.Service.Price)

                </td>
                <td name="PriceMultiplier" class="PriceMultiplier">
                    @((Model.Price ?? 0).ToString("C"))
                </td>
            </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <th colspan="3">Subtotal</th>
                <th> @((Model.Service.Price ?? 0).ToString("C"))</th>
            </tr>
            <tr>
                <th colspan="3">Tax</th>
                <th>
                    @(((Model.Service.Price ?? 0) * .1m).ToString("C"))
                </th>
            </tr>
            <tr>
                <th colspan="3">Total</th>
                <th>
                    @(((Model.Service.Price ?? 0) * 1.1m).ToString("C"))
                </th>
            </tr>
        </tfoot>
    </table>
    <input type="submit" value="Update Frequency" class="btn btn-default" />
    @Html.ActionLink("Check Out", "Index", "Checkout", null, new { @class = "btn btn-primary" })
}

@section Scripts{
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript">
        $("document").ready(function () {
            $("#Recurrence").change(this, function () {
                var selectedIndex = $("#Recurrence").val();
                var selectedService;
                for (var i = 0; i < services.length; i++) {
                    if (services[i].ID == selectedIndex) {
                        selectedService = services[i];
                        break;
                    }
                }

                var multipliedPrice = selectedService.Price * selectedService.Multiplier;

                $(".basePrice").text("$" + multipliedPrice.toFixed(2));

                
            })
        })
        var services = JSON.parse('@Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Service.ServiceRecurrences.Select(x => new { Name = x.Recurrence.Name, ID = x.RecurrenceID, Multiplier = x.PriceMultiplier, Price = x.Service.Price })))');
        </script>

       
    }